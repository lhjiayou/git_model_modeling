# -*- coding: utf-8 -*-
"""
Created on Sun Sep 25 21:19:38 2022

@author: 18721
"""
import numpy as np
import pandas as pd
import statsmodels.api as sm
#task-2
# ç¬¬ä¸€ç« ï¼Œæˆ‘ä»¬å­¦ä¹ äº†å›å½’çš„åŸºæœ¬æ€æƒ³ï¼Œå¹¶ä»‹ç»äº†æœ¬è¯¾ç¨‹ä¸­æœ€é‡è¦ã€æœ€å¸¸ç”¨çš„æ¨¡å‹â€”â€”å¤šå…ƒçº¿æ€§å›å½’æ¨¡å‹ã€‚
# ç¬¬äºŒç« ï¼Œæˆ‘ä»¬ä»‹ç»äº†å¤šå…ƒçº¿æ€§å›å½’æ¨¡å‹çš„åŸºæœ¬å…­å¤§å‡è®¾â€”â€”CLMå‡è®¾ï¼ŒOLSæœ€å°äºŒä¹˜ä¼°è®¡æ³•å¹¶å­¦ä¹ äº†åœ¨è¿™å¥—å‡è®¾ä¸‹çš„æ€§è´¨ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåé¢ä¸¤ç« çš„å†…å®¹å‡å»ºç«‹è¿™äº›OLSæ€§è´¨ä¸Šï¼Œæˆ‘ä»¬éœ€è¦æ—¶åˆ»ç‰¢è®°è¿™ä¸€ç‚¹ã€‚

# task-3
# ç¬¬ä¸‰ç« ï¼Œæˆ‘ä»¬å­¦ä¹ äº†å›å½’åˆ†æä¸­æœ€é‡è¦çš„åˆ†æä»»åŠ¡ä¹‹ä¸€â€”â€”æ¨¡å‹çš„ç»Ÿè®¡æ¨æ–­ï¼Œä»‹ç»äº†å›å½’åˆ†æä¸­å„ç§ç±»å‹çš„å‡è®¾æ£€éªŒã€‚
# ç¬¬å››ç« ï¼Œæˆ‘ä»¬å¯¹çº¿æ€§æ¨¡å‹è¿›è¡Œäº†æ‹“å±•ï¼Œå°†å›å½’å…ƒä»å®šé‡å˜é‡ä¸€æ¬¡é¡¹æ‹“å±•è‡³å®šæ€§å˜é‡ã€å¯¹æ•°é¡¹ã€äºŒæ¬¡é¡¹ã€äº¤äº’é¡¹ï¼Œä½¿æ¨¡å‹è•´å«çš„ä¿¡æ¯æ›´ä¸°å¯Œã€‚


# ä»¥ä¸Šå†…å®¹å‡å»ºç«‹åœ¨æ¨¡å‹ä¸¥æ ¼æ»¡è¶³CLMå‡è®¾çš„å‰æä¸‹ï¼Œä¸€æ—¦æ¨¡å‹è¿èƒŒäº†CLMå‡è®¾ä¸­çš„æŸä¸€æ¡å‡è®¾ï¼Œæ¨¡å‹ä¼°è®¡çš„ç²¾åº¦ã€
# å‡è®¾æ£€éªŒçš„å¯ä¿¡åº¦å°†å—åˆ°å½±å“ã€‚é‚£ä¹ˆï¼Œè¿åæŸæ¡CLMå‡è®¾å…·ä½“ä¼šç»™æ¨¡å‹ä¼°è®¡å¸¦æ¥å¤šå¤§çš„å½±å“å‘¢ï¼Ÿè¿™å°±æ˜¯æœ¬èŠ‚éœ€è¦è®¨è®ºçš„å†…å®¹ã€‚
gpa1=pd.read_stata('./data/gpa1.dta')
# å¸¸è§„è§£æ³•çš„ç»“æœ
gpa_lm1=sm.formula.ols('colGPA~ACT+hsGPA',data=gpa1).fit()
print('å¸¸è§„è§£æ³•çš„ç»“æœ:')
print(gpa_lm1.params[1])
print('-------------------------------------------')
gpa_lm1.summary()
#                  coef    std err          t      P>|t|      [0.025      0.975]
# ------------------------------------------------------------------------------
# Intercept      1.2863      0.341      3.774      0.000       0.612       1.960
# ACT            0.0094      0.011      0.875      0.383      -0.012       0.031
# hsGPA          0.4535      0.096      4.733      0.000       0.264       0.643

# æ–°æ±‚è§£æ³•,ä¹Ÿå°±æ˜¯å…ˆç”¨ACTå¯¹hsGPAè¿›è¡Œæ‹Ÿåˆï¼Œå¾—åˆ°æ®‹å·®ï¼Œç„¶åç”¨yå¯¹æ®‹å·®è¿›è¡Œæ‹Ÿåˆ
gpa_lm2_pre=sm.formula.ols('ACT~hsGPA',data=gpa1).fit()
gpa1['resid']=gpa_lm2_pre.resid
gpa_lm2_pre2=sm.formula.ols('colGPA~resid-1',data=gpa1).fit()
print('æ–°è§£æ³•çš„æ•ˆæœ')
print(gpa_lm2_pre2.params[0])

# 5.2 æ¨¡å‹è¯¯è®¾çš„è¯¯å·®åˆ†æâ€”â€”è¿åMLR.1çš„åæœæ˜¯ä»€ä¹ˆ
# 5.2.1 å¦‚ä½•ç†è§£æ¨¡å‹è¯¯è®¾
# åœ¨MLR.1ä¸­ï¼Œæˆ‘ä»¬å‡è®¾è‡ªå·±è®¾ç½®çš„æ¨¡å‹æ˜¯â€œæ­£ç¡®çš„â€ï¼Œå³å¯¹
# ğ‘¦=ğ›½0+ğ›½1ğ‘¥1+ğ›½2ğ‘¥2+â‹¯+ğ›½ğ‘˜ğ‘¥ğ‘˜+ğ‘¢ 
# çš„å‡è®¾ä¸Šï¼Œæˆ‘ä»¬æ­£ç¡®åœ°çº³å…¥äº†æ‰€æœ‰å…³é”®çš„è‡ªå˜é‡ï¼Œä¸”æ²¡æœ‰çº³å…¥å¤šä½™çš„è‡ªå˜é‡ã€‚è€Œå¤šçº³å…¥ä¸€ä¸ªæ— å…³çš„å˜é‡ï¼Œä»¥åŠå°‘çº³å…¥ä¸€ä¸ªå…³é”®çš„å˜é‡ï¼Œéƒ½èƒ½ç®—æ˜¯è¿åMLR.1


# 5.3 éšæœºè¯¯å·®ä¸æ»¡è¶³æ­£æ€æ€§å‡è®¾
# é¢‘æ•°ç›´æ–¹å›¾
crime1=pd.read_stata('./data/crime1.dta')
crime1.hist(column='narr86',figsize=(8,6))
print(crime1.narr86.value_counts())

# 6. å¼‚æ–¹å·®ä¸‹çš„å›å½’åˆ†æ
# 6.1 å¼‚æ–¹å·®ç¨³å¥çš„tæ£€éªŒä¸Fæ£€éªŒ
# 6.1.1 é‡æ–°ä¼°è®¡æ–¹å·®
#æ–¹å·®ä¸å†æ˜¯å¸¸æ•°ï¼Œä½¿ç”¨ç¨³å¥tæ£€éªŒå’Œç¨³å¥Fæ£€éªŒ

# 6.2 å¼‚æ–¹å·®è¯Šæ–­
# ä¸»è§‚çœ‹å›¾æ³•
# BPä¸€é˜¶æ³•
# whiteäºŒé˜¶æ³•

# 6.3å¹¿ä¹‰OLS
# 6.3.1 wls å¾ˆéš¾çŸ¥é“hxçš„å½¢å¼ï¼Œä¸è€ƒè™‘
# 6.3.2FGLS   ä¸€ç§ä¼°è®¡hxï¼Œå†ç”¨WLSçš„æ–¹æ³•
#ä¸‹é¢æ˜¯FGLSçš„å››ä¸ªæ­¥éª¤ï¼š
# åšå›å½’ ğ‘¦âˆ¼ğ‘¥1+â‹¯ğ‘¥ğ‘˜ ï¼Œå¾—åˆ°æ®‹å·® ğ‘¢Ì‚  
# åšå›å½’ log(ğ‘¢Ì‚ 2)âˆ¼ğ‘¥1+â‹¯+ğ‘¥ğ‘˜ ï¼Œå¾—åˆ°æ‹Ÿåˆå€¼ ğ‘”Ì‚  
# è®¡ç®—å‡½æ•° â„Ì‚ =exp(ğ‘”Ì‚ ) 
# ä»¥ 1/â„Ì‚  åšæƒé‡ï¼Œç”¨wlsä¼°è®¡æ¨¡å‹ ğ‘¦âˆ¼ğ‘¥1+â‹¯ğ‘¥ğ‘˜
smoke=pd.read_stata('./data/smoke.dta')
# ç¬¬ä¸€æ­¥ï¼Œè¿›è¡Œolsä¼°è®¡ï¼Œå¾—åˆ°æ®‹å·®
smoke_lm_ols=sm.formula.ols('cigs~np.log(income)+np.log(cigpric)+educ+age+I(age**2)+restaurn',data=smoke).fit()
smoke['resid']=smoke_lm_ols.resid   #è¿™å°±æ˜¯æ®‹å·®

# ç¬¬äºŒæ­¥ï¼Œæ®‹å·®çš„å¹³æ–¹å¯¹è‡ªå˜é‡è¿›è¡Œå›å½’ï¼Œå¾—åˆ°æ‹Ÿåˆå€¼
smoke_lm_log=sm.formula.ols('np.log(resid**2)~np.log(income)+np.log(cigpric)+educ+age+I(age**2)+restaurn',
                            data=smoke).fit()

#ç¬¬ä¸‰æ­¥ï¼Œè®¡ç®—h_hat
h_hat=np.exp(smoke_lm_log.fittedvalues)

#ç¬¬å››æ­¥ï¼Œä»¥ 1/â„Ì‚  åšæƒé‡ï¼Œç”¨wlsä¼°è®¡æ¨¡å‹ ğ‘¦âˆ¼ğ‘¥1+â‹¯ğ‘¥ğ‘˜
smoke_lm_wls=sm.formula.wls('cigs~np.log(income)+np.log(cigpric)+educ+age+I(age**2)+restaurn',weights=1/h_hat,data=smoke).fit()
print(smoke_lm_wls.summary())

#å‡è®¾åŒæ–¹å·®çš„æ—¶å€™ï¼Œçœ‹ä¼°è®¡çš„æ ‡å‡†è¯¯
smoke_lm_ols=sm.formula.ols('cigs~np.log(income)+np.log(cigpric)+educ+age+I(age**2)+restaurn',data=smoke).fit()
print(smoke_lm_ols.summary())